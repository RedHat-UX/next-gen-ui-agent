---
# Deployment
# Requires a secret with your OPEN API key.
#   Secret name: "openai-api-keys" with Data containing a key 'apitoken' with your Open API key.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: next-gen-ui-mcp
  # namespace: next-gen-ui
  labels:
    app.kubernetes.io/name: next-gen-ui-mcp
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: next-gen-ui-mcp
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: next-gen-ui-mcp
    spec:
      containers:
        - name: mcp-server
          image: "quay.io/next-gen-ui/mcp:latest"
          # imagePullPolicy: Always
          ports:
            - containerPort: 8090
              name: mcp
              protocol: TCP
          env:
            - name: MCP_PORT
              value: "8090"
            - name: NGUI_MODEL
              value: "gpt-4o-mini"
            - name: NGUI_PROVIDER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openai-api-keys
                  key: apitoken
          startupProbe:
            httpGet:
              path: /liveness
              port: mcp
              scheme: HTTP
            initialDelaySeconds: 3
            timeoutSeconds: 1
            periodSeconds: 1 # starts probing very quickly
            successThreshold: 1
            failureThreshold: 60 # should start in 1 minute
          livenessProbe:
            httpGet:
              path: /liveness
              port: mcp
              scheme: HTTP
            initialDelaySeconds: 3
            timeoutSeconds: 30
            periodSeconds: 30
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /readiness
              port: mcp
              scheme: HTTP
            initialDelaySeconds: 4
            timeoutSeconds: 30
            periodSeconds: 30
            successThreshold: 1
            failureThreshold: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: next-gen-ui-mcp
  name: next-gen-ui-mcp
  # namespace: next-gen-ui
spec:
  ports:
    - name: mcp
      port: 8090
      targetPort: mcp
  selector:
    app.kubernetes.io/name: next-gen-ui-mcp
